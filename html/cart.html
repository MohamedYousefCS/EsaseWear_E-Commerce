<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="../css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/master.css">
    <title>Cart</title>
</head>

<body>

    <!-- navbar -->
    <section id="header">
    </section>
    <!-- Cart section -->
    <section id="blog-home" class="pt-5 mt-5 container">
        <!--alert -->
        <div class="row">
            <div id="AlertEmptyCart" class="col-6" style="text-align: center;margin: 0 auto;">
            </div>
        </div>
        <h2 class="font-weight-bold pt-5">Shopping Cart</h2>
        <hr>
    </section>
    <section id="cart-container" class="container my-5">
        <table width="100%">
            <thead>
                <tr>
                    <td>Remove</td>
                    <td>Image</td>
                    <td>Product</td>
                    <td>Price</td>
                    <td>Quantity</td>
                    <td>Total</td>
                </tr>
            </thead>
            <tbody id="cartBody">
                <!-- Dynamic data will be inserted here -->
            </tbody>
        </table>
    </section>
    <!-- Cart section end -->

    <!-- total and coupon section -->
    <section id="cart-bottom" class="container">
        <div class="row">
            <div class="coupon col-12 col-md-6 mb-4">
                <div>
                    <h5>COUPON</h5>
                    <p>Enter your coupon code if you have one.</p>
                    <input type="text" id="couponCode" placeholder="Coupon Code">
                    <button id="applyCouponBtn">Apply Coupon</button>
                </div>
            </div>
            <div class="total col-12 col-md-6 ">
                <div>
                    <h5>CART TOTAL</h5>
                    <div class="d-flex justify-content-between">
                        <h6>Subtotal</h6>
                        <p id="subtotal">$0.00</p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <h6>Shipping</h6>
                        <p id="shipping">$15.00</p>
                    </div>
                    <div class="d-flex justify-content-between" id="appliedCoupon">
                        <!-- Applied coupon will be displayed here -->
                    </div>
                    <hr class="second-hr">
                    <div class="d-flex justify-content-between">
                        <h6>Total</h6>
                        <p id="lastTotal">$0.00</p>
                    </div>
                    <button class="ml-auto" id="k">Proceed to checkout</button>
                </div>
            </div>
        </div>
    </section>






    <div id="footer"></div>

    <script src="../components/navbar/nav.js"></script>
    <script src="../components/footer/footer.js"></script>



    <script>
        function validateInput(input) {
            var inputValue = parseInt(input.value, 10);
            // Check if the value is negative or greater than the max allowed value
            if (inputValue < 0 || inputValue > parseInt(input.max, 10) || isNaN(inputValue)) {
                // If negative, greater than max, or not a number, set the value to the minimum allowed value
                input.value = input.min;
            }
        }
        const coupons = {
            "iti_5": 5,
            "iti_10": 10,
            "iti_15": 15,
            "iti_25": 25,
            "iti_50": 50
        };

        localStorage.setItem("coupons", JSON.stringify(coupons));
        document.addEventListener("DOMContentLoaded", function () {
            let currentUserId = JSON.parse(localStorage.getItem("user"))?.id;
            let appliedCouponDiv = document.getElementById("appliedCoupon");
            let subtotalElement = document.getElementById("subtotal");
            let shippingElement = document.getElementById("shipping");
            let totalElement = document.getElementById("lastTotal");
            let applyCouponBtn = document.getElementById("applyCouponBtn");
            let couponCodeInput = document.getElementById("couponCode");
            let appliedCoupon = document.getElementById("appliedCoupon");
            let mTotal = 0;
            let subTotal = 0;
            let itemPrice = 0;
            if (currentUserId) {
                let cartData = JSON.parse(localStorage.getItem("cartData")) || [];
                let userCart = cartData.filter(item => item.userId === currentUserId);
                let cartBody = document.getElementById("cartBody");
                if (userCart.length > 0) {
                    let productsData = JSON.parse(localStorage.getItem("products")) || {};
                    console.log(productsData);
                    userCart.forEach(function (cartItem) {
                        var productId = cartItem.productId;
                        if (cartItem.productId) {
                            //  let productIndex = productsData.findIndex((product) => +product.product_id === +productId);
                            let productIndex = -1;
                            for (let index = 0; index < productsData.length; index++) {
                                if (parseInt(productsData[index].product_id) === parseInt(productId)) {
                                    productIndex = index;
                                    break;
                                }
                            }
                            if (productIndex !== -1) {
                                let productDetails = productsData[productIndex];
                                console.log(productDetails);
                                if (productDetails) {
                                    let totalPrice = parseFloat(productDetails.price) * parseInt(cartItem.numOfItems);
                                    itemPrice = totalPrice;
                                    let newRow = document.createElement("tr");
                                    newRow.innerHTML = `
                            <td><a href="#" class="remove-item"><i class="fas fa-trash-alt"></i></a></td>
                            <td><img src="${productDetails.product_img}" alt="Cart Img"></td>
                            <td><h5>${productDetails.product_name}</h5></td>
                            <td><h5>${productDetails.price}</h5></td>
                            <td><input class="w-50 pl-1" type="number" value="${cartItem.numOfItems}" min="1" max="5" oninput="validateInput(this)"  data-product-id="${productId}"></td>
                            <td><h5 class="totalPrice">$${totalPrice.toFixed(2)}</h5></td>
                        `;
                                    cartBody.appendChild(newRow);
                                    let quantityInput = newRow.querySelector('input');
                                    quantityInput.addEventListener('change', function () {
                                        cartItem.numOfItems = parseInt(this.value);
                                        totalPrice = parseFloat(productDetails.price) * parseInt(cartItem.numOfItems);
                                        newRow.querySelector('.totalPrice').innerText = "$" + totalPrice.toFixed(2);
                                        localStorage.setItem("cartData", JSON.stringify(cartData));
                                        let initialSubtotal = calculateSubtotal();
                                        subtotalElement.innerText = `$${initialSubtotal.toFixed(2)}`;
                                        updateTotal();
                                    });
                                    let removeIcon = newRow.querySelector('.remove-item');
                                    removeIcon.addEventListener('click', function (event) {
                                        event.preventDefault();
                                        const Toast = Swal.mixin({
                                            toast: true,
                                            position: "top-end",
                                            showConfirmButton: false,
                                            timer: 3000,
                                            timerProgressBar: true,
                                            didOpen: (toast) => {
                                                toast.onmouseenter = Swal.stopTimer;
                                                toast.onmouseleave = Swal.resumeTimer;
                                            }
                                        });
                                        Swal.fire({
                                            title: "Are you sure?",
                                            text: "Do you want to delete this item from your cart?",
                                            icon: "warning",
                                            showCancelButton: true,
                                            confirmButtonColor: "#3085d6",
                                            cancelButtonColor: "#d33",
                                            confirmButtonText: "Yes, delete it!"
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                newRow.remove();
                                                cartData = cartData.filter(item => item.productId !== productId);
                                                localStorage.setItem("cartData", JSON.stringify(cartData));
                                                calculateSubtotal();
                                                updateTotal();
                                                Toast.fire({
                                                    icon: "Deleted",
                                                    title: "the item has been deleted.",
                                                    icon: "success"
                                                });
                                            }
                                        });
                                    });
                                }
                            }

                            else {
                                console.warn("Product details not found for productId:", productId);
                            }
                        }
                    });
                    function calculateSubtotal() {
                        let subtotal = 0;
                        let userCart = cartData.filter(item => item.userId === currentUserId);

                        userCart.forEach(function (cartItem) {
                            let productId = cartItem.productId;
                            let productDetails = productsData[productId];
                            if (productDetails) {
                                subtotal += parseFloat(productDetails.price) * parseInt(cartItem.numOfItems);
                            }
                        });
                        subTotal = subtotal;
                        subtotalElement.innerText = `$${subtotal.toFixed(2)}`;
                        return subtotal;
                    }

                    let initialSubtotal = calculateSubtotal();
                    subtotalElement.innerText = `$${initialSubtotal.toFixed(2)}`;
                    updateTotal();

                    applyCouponBtn.addEventListener('click', function () {
                        let couponCode = couponCodeInput.value;
                        const coupons = JSON.parse(localStorage.getItem("coupons")) || {};

                        if (coupons.hasOwnProperty(couponCode)) {
                            appliedCoupon.innerHTML = `<h6>Applied Coupon</h6>
                        <p id="couponValue">$${coupons[couponCode]}</p>`;
                            updateTotal();
                        } else {
                            appliedCoupon.innerHTML = `<p style="color: red;">Invalid Coupon</p>
                        <p id="couponValue" style='display:none'>$0</p>`;
                            updateTotal();
                        }
                    });
                } else {
                    shippingElement.innerText = "$0.00";
                    cartBody.innerHTML = `<tr  height='30px'><td colspan="6">Your cart is empty</td></tr>`;
                }
            } else {
                shippingElement.innerText = "$0.00";
                document.getElementById("cartBody").innerHTML = `<tr  height='30px'><td colspan="6">Please log in to view your cart</td></tr>`;
            }

            function updateTotal() {
                let subtotalElement = document.getElementById("subtotal");
                let shippingElement = document.getElementById("shipping");
                let couponValue = document.getElementById("couponValue") || { innerText: "$0" };

                if (subtotalElement && shippingElement) {
                    let subtotal = parseFloat(subtotalElement.innerText.replace('$', '')) || 0;
                    let shipping = parseFloat(shippingElement.innerText.replace('$', '')) || 0;
                    let coupon = parseFloat(couponValue.innerText.replace('$', '')) || 0;
                    let total = subtotal + shipping - coupon;
                    totalElement.innerText = `$${total.toFixed(2)}`;
                    mTotal = total;
                }
            }

            document.getElementById("k").addEventListener("click", function () {
                localStorage.setItem('totalPrice', mTotal);
                localStorage.setItem('subTotal', subTotal);
                var alertContent = document.getElementById("AlertEmptyCart");
                var cartCurrentData = JSON.parse(localStorage.getItem("cartData"));
                if (cartCurrentData.length < 1) {
                    alertContent.innerHTML = `<div class="alert alert-danger">
                You can't Proceed to checkout Your cart is Empty!
            </div>`;
                    setTimeout(function () {
                        alertContent.classList.add("hidden");
                    }, 3000);
                } else {
                    window.location.href = 'checkout.html';
                }
            });
        });
    </script>
    <!-- script for cart end -->


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
    <script src="../js/all.min.js"></script>
</body>

</html>